<!DOCTYPE html><html lang="en-uk" >

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Wowchemy 5.2.0 for Hugo" />
  

  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Guy Abel" />

  
  
  
    
  
  <meta name="description" content="Background A little while ago my paper in International Migration Review on global migration flow estimates came out online. The paper includes a number of directional chord diagrams to visualize the estimates." />

  
  <link rel="alternate" hreflang="en-uk" href="https://guyabel.com/post/animated-directional-chord-diagrams/" />

  







  




  
  
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    <meta name="theme-color" content="#4caf50" />
  

  
  

  
  
  
  
    
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous">

    
    
    
    
      
      
    
    
    

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/github.min.css" crossorigin="anonymous" title="hl-light" media="print" onload="this.media='all'">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" media="print" onload="this.media='all'" disabled>
        
      
    

    
    
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.css" integrity="sha512-1xoFisiGdy9nvho8EgXuXvnpR5GAMSjFwp40gSRE3NwdUdIMIKuPa7bqoUhLD0O/5tPNhteAsE5XyyMi5reQVA==" crossorigin="anonymous" media="print" onload="this.media='all'">
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      
        
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
    
      
      <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media="print" onload="this.media='all'">
    
  

  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.ba8da8579ac44c98b451dcba49b90383.css" />

  




<script async src="https://www.googletagmanager.com/gtag/js?id=G-QV9ZK83YH1"></script>
<script>
  window.dataLayer = window.dataLayer || [];

  function gtag() {
      dataLayer.push(arguments);
  }

  function trackOutboundLink(url, target) {
    gtag('event', 'click', {
         'event_category': 'outbound',
         'event_label': url,
         'transport_type': 'beacon',
         'event_callback': function () {
           if (target !== '_blank') {
             document.location = url;
           }
         }
    });
    console.debug("Outbound link clicked: " + url);
  }

  function onClickCallback(event) {
    if ((event.target.tagName !== 'A') || (event.target.host === window.location.host)) {
      return;
    }
    trackOutboundLink(event.target, event.target.getAttribute('target'));  
  }

  gtag('js', new Date());
  gtag('config', 'G-QV9ZK83YH1', {});
  gtag('set', {'cookie_flags': 'SameSite=None;Secure'});

  
  document.addEventListener('click', onClickCallback, false);
</script>


  

  

  




  
  
  

  

  
    <link rel="manifest" href="/index.webmanifest" />
  

  <link rel="icon" type="image/png" href="/media/icon_hua235b20c26de23a006d4e436991121ab_642_32x32_fill_lanczos_center_2.png" />
  <link rel="apple-touch-icon" type="image/png" href="/media/icon_hua235b20c26de23a006d4e436991121ab_642_180x180_fill_lanczos_center_2.png" />

  <link rel="canonical" href="https://guyabel.com/post/animated-directional-chord-diagrams/" />

  
  
  
  
  
  
  
  
    
  
  
  <meta property="twitter:card" content="summary_large_image" />
  
  <meta property="og:site_name" content="Guy Abel" />
  <meta property="og:url" content="https://guyabel.com/post/animated-directional-chord-diagrams/" />
  <meta property="og:title" content="R code for animated chord diagrams | Guy Abel" />
  <meta property="og:description" content="Background A little while ago my paper in International Migration Review on global migration flow estimates came out online. The paper includes a number of directional chord diagrams to visualize the estimates." /><meta property="og:image" content="https://guyabel.com/post/animated-directional-chord-diagrams/featured.png" />
    <meta property="twitter:image" content="https://guyabel.com/post/animated-directional-chord-diagrams/featured.png" /><meta property="og:locale" content="en-uk" />
  
    
      <meta
        property="article:published_time"
        content="2018-04-18T00:00:00&#43;00:00"
      />
    
    <meta property="article:modified_time" content="2018-04-18T00:00:00&#43;00:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://guyabel.com/post/animated-directional-chord-diagrams/"
  },
  "headline": "R code for animated chord diagrams",
  
  "image": [
    "https://guyabel.com/post/animated-directional-chord-diagrams/featured.png"
  ],
  
  "datePublished": "2018-04-18T00:00:00Z",
  "dateModified": "2018-04-18T00:00:00Z",
  
  "author": {
    "@type": "Person",
    "name": "Guy Abel"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "Guy Abel",
    "logo": {
      "@type": "ImageObject",
      "url": "https://guyabel.com/media/icon_hua235b20c26de23a006d4e436991121ab_642_192x192_fill_lanczos_center_2.png"
    }
  },
  "description": "Background A little while ago my paper in International Migration Review on global migration flow estimates came out online. The paper includes a number of directional chord diagrams to visualize the estimates."
}
</script>

  

  

  

  





  <title>R code for animated chord diagrams | Guy Abel</title>
</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " data-wc-page-id="5b3f774f2a2c9ff17d3f472330326c01" >

  
  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.b8153d4570dcbb34350a2a846dba8c03.js"></script>

  


<aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="Close"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control"
        aria-label="Search...">
        
      </div>

      
      

      

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>



  <div class="page-header">
    












<nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
  <div class="container-xl">

    
    <div class="d-none d-lg-inline-flex">
      <a class="navbar-brand" href="/">Guy Abel</a>
    </div>
    

    
    <button type="button" class="navbar-toggler" data-toggle="collapse"
            data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="Toggle navigation">
    <span><i class="fas fa-bars"></i></span>
    </button>
    

    
    <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
      <a class="navbar-brand" href="/">Guy Abel</a>
    </div>
    

    
    
    <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

      
      <ul class="navbar-nav d-md-inline-flex">
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#about"><span>About</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#featured"><span>Publications</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#posts"><span>Posts</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#packages"><span>R Packages</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#contact"><span>Contact</span></a>
        </li>

        
        

      

        
      </ul>
    </div>

    <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

      
      
        
          
          <li class="nav-item d-none d-lg-inline-flex">
            <a class="nav-link" href="/"  aria-label="">
              <i class="fas fa-" aria-hidden="true"></i>
            </a>
          </li>
        
      

      
      
      <li class="nav-item">
        <a class="nav-link js-search" href="#" aria-label="Search"><i class="fas fa-search" aria-hidden="true"></i></a>
      </li>
      

      
      
      <li class="nav-item dropdown theme-dropdown">
        <a href="#" class="nav-link" data-toggle="dropdown" aria-haspopup="true" aria-label="Display preferences">
          <i class="fas fa-moon" aria-hidden="true"></i>
        </a>
        <div class="dropdown-menu">
          <a href="#" class="dropdown-item js-set-theme-light">
            <span>Light</span>
          </a>
          <a href="#" class="dropdown-item js-set-theme-dark">
            <span>Dark</span>
          </a>
          <a href="#" class="dropdown-item js-set-theme-auto">
            <span>Automatic</span>
          </a>
        </div>
      </li>
      

      
      

    </ul>

  </div>
</nav>


  </div>

  <div class="page-body">
    
<div class="container-fluid docs">
    <div class="row flex-xl-nowrap">
      <div class="d-none d-xl-block col-xl-2 docs-toc">
        <ul class="nav toc-top">
          <li>
            <a href="#" id="back_to_top" class="docs-toc-title">
              Contents
            </a>
          </li>
        </ul>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#background">Background</a></li>
    <li><a href="#data">Data</a></li>
    <li><a href="#tween">Tween</a></li>
    <li><a href="#plots-for-each-frame">Plots for Each Frame</a></li>
    <li><a href="#creating-an-animation">Creating an animation</a></li>
    <li><a href="#fixing-scales-in-chord-diagrams">Fixing Scales in Chord Diagrams</a></li>
  </ul>
</nav>

      </div>
      <main class="col-12 col-md-0 col-xl-10 py-md-3 pl-md-5 docs-content" role="main">

        <article class="article">
          









<div class="article-header">
  
  
    <img src="/media/headers/animated-directional-chord-diagrams.png" class="article-banner" alt="[Global Migration Flow Estimates](http://guyabel.com/publication/global-migration-estimates-by-gender/)">
  

  <span class="article-header-caption"><a href="http://guyabel.com/publication/global-migration-estimates-by-gender/">Global Migration Flow Estimates</a></span>
</div>




  

  
  
  
<div class="article-container pt-3">
  <h1>R code for animated chord diagrams</h1>

  

  
    


<div class="article-metadata">

  
  
  
  
  <div>
    

  <span >
      
 Guy Abel
    </span>
  </div>
  
  

  
  <span class="article-date">
    
    
      
    
    Apr 18, 2018
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    9 min read
  </span>
  

  
  
  
  
  
  

  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="/categories/r/">R</a>, <a href="/categories/migration/">migration</a>, <a href="/categories/chord-diagram/">chord diagram</a>, <a href="/categories/r-bloggers/">r-bloggers</a></span>
  

</div>

    





  
</div>


          <div class="article-container">
            <div class="article-style">
              <h2 id="background">Background</h2>
<p>A little while ago my paper in <em>International Migration Review</em> on global migration flow estimates came out <a href="http://guyabel.com/publication/global-migration-estimates-by-gender/" target="_blank" rel="noopener">online</a>. The paper includes a number of directional chord diagrams to visualize the estimates.</p>
<p>Recently I have been playing around <code>tweenr</code> and the <code>magick</code> packages for animated population pyramids. In this post I attempt to show how to use these packages to produce animated directional chord diagrams of global migration flow estimates</p>
<h2 id="data">Data</h2>
<p>The first step is to read into R two data frames (these are in my <code>migest</code> R package if you wish to replicate the code below).</p>
<ol>
<li>Time series of bilateral migration flow estimates:</li>
</ol>
<pre><code class="language-r"># install.packages(&quot;migest&quot;)
library(tidyverse)
d0 &lt;- read_csv(system.file(&quot;imr&quot;, &quot;reg_flow.csv&quot;, package = &quot;migest&quot;))
d0 
</code></pre>
<pre><code>## # A tibble: 891 × 4
##    year0 orig_reg     dest_reg                         flow
##    &lt;dbl&gt; &lt;chr&gt;        &lt;chr&gt;                           &lt;dbl&gt;
##  1  1960 Africa       Africa                        1377791
##  2  1960 Africa       Eastern Asia                     5952
##  3  1960 Africa       Eastern Europe &amp; Central Asia    7303
##  4  1960 Africa       Europe                         919252
##  5  1960 Africa       Latin America &amp; Caribbean       15796
##  6  1960 Africa       Northern America                82463
##  7  1960 Africa       Oceania                         32825
##  8  1960 Africa       Southern Asia                   35603
##  9  1960 Africa       Western Asia                   106580
## 10  1960 Eastern Asia Africa                          37301
## # … with 881 more rows
</code></pre>
<ol start="2">
<li>Some regional meta data for chord diagram plots:</li>
</ol>
<pre><code class="language-r">d1 &lt;- read_csv(system.file(&quot;vidwp&quot;, &quot;reg_plot.csv&quot;, package = &quot;migest&quot;))
d1
</code></pre>
<pre><code>## # A tibble: 9 × 5
##   region                        order1 col1    reg1           reg2          
##   &lt;chr&gt;                          &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;          &lt;chr&gt;         
## 1 Northern America                   1 #40A4D8 Northern       America       
## 2 Africa                             2 #33BEB7 Africa         &lt;NA&gt;          
## 3 Europe                             3 #B2C224 Europe         &lt;NA&gt;          
## 4 Eastern Europe &amp; Central Asia      4 #FECC2F Eastern Europe &amp; Central Asia
## 5 Western Asia                       5 #FBA127 Western        Asia          
## 6 Southern Asia                      6 #F66320 Southern       Asia          
## 7 Eastern Asia                       7 #DB3937 Eastern        Asia          
## 8 Oceania                            8 #A463D7 Oceania        &lt;NA&gt;          
## 9 Latin America &amp; Caribbean          9 #0C5BCE Latin America  &amp; Caribbean
</code></pre>
<h2 id="tween">Tween</h2>
<p>The next step is to tween the data by migration corridor.</p>
<pre><code class="language-r">library(tweenr)

d2 &lt;- d0 %&gt;%
  mutate(corridor = paste(orig_reg, dest_reg, sep = &quot; -&gt; &quot;)) %&gt;%
  select(corridor, year0, flow) %&gt;%
  mutate(ease = &quot;linear&quot;) %&gt;%
  tween_elements(time = &quot;year0&quot;, group = &quot;corridor&quot;, ease = &quot;ease&quot;, nframes = 100) %&gt;%
  as_tibble()
d2
</code></pre>
<pre><code>## # A tibble: 8,181 × 4
##    year0    flow .frame .group                                 
##    &lt;dbl&gt;   &lt;dbl&gt;  &lt;int&gt; &lt;chr&gt;                                  
##  1  1960 1377791      0 Africa -&gt; Africa                       
##  2  1960    5952      0 Africa -&gt; Eastern Asia                 
##  3  1960    7303      0 Africa -&gt; Eastern Europe &amp; Central Asia
##  4  1960  919252      0 Africa -&gt; Europe                       
##  5  1960   15796      0 Africa -&gt; Latin America &amp; Caribbean    
##  6  1960   82463      0 Africa -&gt; Northern America             
##  7  1960   32825      0 Africa -&gt; Oceania                      
##  8  1960   35603      0 Africa -&gt; Southern Asia                
##  9  1960  106580      0 Africa -&gt; Western Asia                 
## 10  1960   37301      0 Eastern Asia -&gt; Africa                 
## # … with 8,171 more rows
</code></pre>
<p>This creates larger data frame <code>d2</code>, with 100 observations for each corridor, one for each frame in the animation. In the original data <code>d0</code> there are only 11 observations for each corridor, one for each five-year period.</p>
<p>Then some further minor data wrangling is required to ready the data for plotting using the <code>chordDiagram</code> function; namely the first three columns in the data must correspond to the origin, destination and flow.</p>
<pre><code class="language-r">d2 &lt;- d2 %&gt;%
  separate(col = .group, into = c(&quot;orig_reg&quot;, &quot;dest_reg&quot;), sep = &quot; -&gt; &quot;) %&gt;%
  select(orig_reg, dest_reg, flow, everything()) %&gt;%
  mutate(flow = flow/1e06)
d2
</code></pre>
<pre><code>## # A tibble: 8,181 × 5
##    orig_reg     dest_reg                         flow year0 .frame
##    &lt;chr&gt;        &lt;chr&gt;                           &lt;dbl&gt; &lt;dbl&gt;  &lt;int&gt;
##  1 Africa       Africa                        1.38     1960      0
##  2 Africa       Eastern Asia                  0.00595  1960      0
##  3 Africa       Eastern Europe &amp; Central Asia 0.00730  1960      0
##  4 Africa       Europe                        0.919    1960      0
##  5 Africa       Latin America &amp; Caribbean     0.0158   1960      0
##  6 Africa       Northern America              0.0825   1960      0
##  7 Africa       Oceania                       0.0328   1960      0
##  8 Africa       Southern Asia                 0.0356   1960      0
##  9 Africa       Western Asia                  0.107    1960      0
## 10 Eastern Asia Africa                        0.0373   1960      0
## # … with 8,171 more rows
</code></pre>
<h2 id="plots-for-each-frame">Plots for Each Frame</h2>
<p>Now the data is in the correct format, chord diagrams can be produced for each frame of the eventual animation. To do this, I used a <code>for</code> loop to cycle through the tweend data. The arguments I used in the <code>circos.par</code>, <code>chordDiagram</code> and <code>circos.track</code> functions to produce each plot are explained in more detail in the comments of the <code>migest</code> <a href="https://github.com/guyabel/migest/blob/master/demo/cfplot_reg2.R" target="_blank" rel="noopener">demo</a>.</p>
<pre><code class="language-r"># create a directory to store the individual plots
dir.create(&quot;./plot-ani/&quot;)

library(circlize)
for(f in unique(d2$.frame)){
  # open a PNG plotting device
  png(file = paste0(&quot;./plot-ani/globalchord&quot;, f, &quot;.png&quot;), height = 7, width = 7, 
      units = &quot;in&quot;, res = 500)
  
  # initialise the circos plot
  circos.clear()
  par(mar = rep(0, 4), cex=1)
  circos.par(start.degree = 90, track.margin=c(-0.1, 0.1), 
             gap.degree = 4, points.overflow.warning = FALSE)

  # plot the chord diagram
  chordDiagram(x = filter(d2, .frame == f), directional = 1, order = d1$region,
               grid.col = d1$col1, annotationTrack = &quot;grid&quot;,
               transparency = 0.25,  annotationTrackHeight = c(0.05, 0.1),
               direction.type = c(&quot;diffHeight&quot;, &quot;arrows&quot;), link.arr.type = &quot;big.arrow&quot;,
               diffHeight  = -0.04, link.sort = TRUE, link.largest.ontop = TRUE)
  
  # add labels and axis
  circos.track(track.index = 1, bg.border = NA, panel.fun = function(x, y) {
    xlim = get.cell.meta.data(&quot;xlim&quot;)
    sector.index = get.cell.meta.data(&quot;sector.index&quot;)
    reg1 = d1 %&gt;% filter(region == sector.index) %&gt;% pull(reg1)
    reg2 = d1 %&gt;% filter(region == sector.index) %&gt;% pull(reg2)
    
    circos.text(x = mean(xlim), y = ifelse(is.na(reg2), 3, 4),
                labels = reg1, facing = &quot;bending&quot;, cex = 1.1)
    circos.text(x = mean(xlim), y = 2.75, labels = reg2, facing = &quot;bending&quot;, cex = 1.1)
    circos.axis(h = &quot;top&quot;, labels.cex = 0.8
                labels.niceFacing = FALSE, labels.pos.adjust = FALSE)
  })
  
  # close plotting device
  dev.off()
}
</code></pre>
<h2 id="creating-an-animation">Creating an animation</h2>
<p>Using the <code>magick</code> package an animation can be created by using the code below to</p>
<ol>
<li>Read in an initial plot and then combine together all other images created above.</li>
<li>Scale the combined images.</li>
<li>Animate the combined images and save as a <code>.gif</code> or <code>mp4</code></li>
</ol>
<pre><code class="language-r">library(magick)

img &lt;- image_read(path = &quot;./plot-ani/globalchord0.png&quot;)
for(f in unique(d2$.frame)[-1]){
  img0 &lt;- image_read(path = paste0(&quot;./plot-ani/globalchord&quot;,f,&quot;.png&quot;))
  img &lt;- c(img, img0)
  message(f)
}

img1 &lt;- image_scale(image = img, geometry = &quot;720x720&quot;)

ani0 &lt;- image_animate(image = img1, fps = 10)
image_write(image = ani0, path = &quot;./plot-ani/globalchord.gif&quot;)
image_write_video(image = img1, path = &quot;./plot-ani/globalchord.mp4&quot;, framerate = 10)
</code></pre>
<p>This gives an output much like this minus the additional details in the corners:</p>
<style>
video {
  /* override other styles to make responsive */
  width: 100%    !important;
  height: auto   !important;
  max-height: 720px
}
</style>
<video loop controls muted playsinline preload="none" poster="abel-ani10-gf-dist.png">
<source src="abel-ani10-gf-dist.mp4" type="video/mp4"/>
</video> 
<h2 id="fixing-scales-in-chord-diagrams">Fixing Scales in Chord Diagrams</h2>
<p>Whilst the plot above allows comparisons of the distributions of flows overtime it is more difficult to compare volumes. For such comparisons, Zuguang Gu <a href="http://zuguang.de/circlize_book/book/advanced-usage-of-chorddiagram.html#compare-two-chord-diagrams" target="_blank" rel="noopener">suggests</a> scaling the gaps between the sectors on the outside of the chord diagram. I wrote a little function that can do this for flow data arranged in a tidy format;</p>
<pre><code class="language-r">scale_gap &lt;- function(flow_m, flow_max, gap_at_max = 1, gaps = NULL) {
  p &lt;- flow_m / flow_max
  if(length(gap_at_max) == 1 &amp; !is.null(gaps)) {
    gap_at_max &lt;- rep(gap_at_max, gaps)
  }
  gap_degree &lt;- (360 - sum(gap_at_max)) * (1 - p)
  gap_m &lt;- (gap_degree + sum(gap_at_max))/gaps
  return(gap_m)
}
</code></pre>
<p>where</p>
<ul>
<li><code>flow_m</code> is the size of total flows in the matrix for the given year being re-scaled.</li>
<li><code>flow_max</code> is the maximum size of the flow matrix over all years</li>
<li><code>gap_at_max</code> is the size in degrees of the gaps in the flow matrix in the year where the flows are at their all time maximum.</li>
<li><code>gaps</code> is the number of gaps in the chord diagram (i.e. the number of regions).</li>
</ul>
<p>The function can be used to derive the size of gaps in each frame for a new animation.</p>
<pre><code class="language-r">d3 &lt;- d2 %&gt;%
  group_by(.frame) %&gt;%
  summarise(flow = sum(flow)) %&gt;%
  mutate(gaps = scale_gap(flow_m = flow, flow_max = max(.$flow), 
                          gap_at_max = 4, gaps = 9))

d3
</code></pre>
<pre><code>## # A tibble: 101 × 3
##    .frame  flow  gaps
##     &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1      0  17.6  25.9
##  2      1  17.8  25.7
##  3      2  18.1  25.6
##  4      3  18.3  25.4
##  5      4  18.5  25.2
##  6      5  18.7  25.1
##  7      6  18.9  24.9
##  8      7  19.1  24.7
##  9      8  19.3  24.6
## 10      9  19.6  24.4
## # … with 91 more rows
</code></pre>
<p>The calculations in <code>d3</code> can then be plugged into the <code>for</code> loop above, where the <code>circos.par()</code> function is replaced by</p>
<pre><code class="language-r">circos.par(start.degree = 90, track.margin = c(-0.1, 0.1),
           gap.degree = filter(d3, .frame == f)$gaps, 
           points.overflow.warning = FALSE)
</code></pre>
<p>Once the for loop has produced a new set of images, the same code to produce previous animation can be run to obtain the animated chord diagrams with changing gaps;</p>
<video loop controls muted playsinline preload="none" poster="abel-ani10-gf-gap.png">
<source src="abel-ani10-gf-gap.mp4" type="video/mp4"/>
</video> 
<p>Whilst the sector axes are now fixed, I am not convinced that changing the relative gaps is the best way to compare volumes when using animated chord diagrams. The sectors of all regions - bar Northern America - are rotating making it hard follow their changes over time.</p>
<p>Fortunately there is new <code>xmax</code> option in <code>chordDiagram</code> that can be used to fix the lengths of the x-axis for each sector using a named vector. In the context of producing an animation, the historic maximum migration flows (of combined immigration and emigration flows) in each region can be used, calculated from the original data <code>d0</code></p>
<pre><code class="language-r">library(magrittr)

reg_max &lt;- d0 %&gt;%
  group_by(year0, orig_reg) %&gt;%
  mutate(tot_out = sum(flow)) %&gt;%
  group_by(year0, dest_reg) %&gt;%
  mutate(tot_in = sum(flow)) %&gt;%
  filter(orig_reg == dest_reg) %&gt;%
  mutate(tot = tot_in + tot_out) %&gt;%
  mutate(reg = orig_reg) %&gt;%
  group_by(reg) %&gt;%
  summarise(tot_max = max(tot)/1e06) %$%
  'names&lt;-'(tot_max, reg)

reg_max
</code></pre>
<pre><code>##                        Africa                  Eastern Asia 
##                     17.429942                     14.805479 
## Eastern Europe &amp; Central Asia                        Europe 
##                      8.361300                     15.536978 
##     Latin America &amp; Caribbean              Northern America 
##                      7.697638                     10.416927 
##                       Oceania                 Southern Asia 
##                      2.968412                     15.067631 
##                  Western Asia 
##                     15.072561
</code></pre>
<p>The <code>reg_max</code> object can then be used in the <code>chordDiagram</code> function in the <code>for</code> loop above, replacing the original call with</p>
<pre><code class="language-r">chordDiagram(x = filter(d2, .frame == f), directional = 1, order = d1$region,
             grid.col = d1$col1, annotationTrack = &quot;grid&quot;,
             transparency = 0.25,  annotationTrackHeight = c(0.05, 0.1),
             direction.type = c(&quot;diffHeight&quot;, &quot;arrows&quot;), link.arr.type = &quot;big.arrow&quot;,
             diffHeight  = -0.04, link.sort = TRUE, link.largest.ontop = TRUE, 
             xmax = reg_max)
</code></pre>
<p>Running the complete code - the adapted <code>for</code> loop to produce the images and then the <code>magick</code> functions to compile the animation - results in the following:</p>
<video loop controls muted playsinline preload="none" poster="abel-ani10-gf-fix.png">
  <source src="abel-ani10-gf-fix.mp4" type="video/mp4"/>
</video> 

            </div>
            






<div class="article-tags">
  
  <a class="badge badge-light" href="/tag/academic/">Academic</a>
  
</div>



<div class="share-box" aria-hidden="true">
  <ul class="share">
    
      
      
      
        
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=https://guyabel.com/post/animated-directional-chord-diagrams/&amp;text=R%20code%20for%20animated%20chord%20diagrams" target="_blank" rel="noopener" class="share-btn-twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=https://guyabel.com/post/animated-directional-chord-diagrams/&amp;t=R%20code%20for%20animated%20chord%20diagrams" target="_blank" rel="noopener" class="share-btn-facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="mailto:?subject=R%20code%20for%20animated%20chord%20diagrams&amp;body=https://guyabel.com/post/animated-directional-chord-diagrams/" target="_blank" rel="noopener" class="share-btn-email">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=https://guyabel.com/post/animated-directional-chord-diagrams/&amp;title=R%20code%20for%20animated%20chord%20diagrams" target="_blank" rel="noopener" class="share-btn-linkedin">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="whatsapp://send?text=R%20code%20for%20animated%20chord%20diagrams%20https://guyabel.com/post/animated-directional-chord-diagrams/" target="_blank" rel="noopener" class="share-btn-whatsapp">
          <i class="fab fa-whatsapp"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://service.weibo.com/share/share.php?url=https://guyabel.com/post/animated-directional-chord-diagrams/&amp;title=R%20code%20for%20animated%20chord%20diagrams" target="_blank" rel="noopener" class="share-btn-weibo">
          <i class="fab fa-weibo"></i>
        </a>
      </li>
    
  </ul>
</div>











  
  
    



  
  
  
    
  
  
  
  <div class="media author-card content-widget-hr">
    
      
      <a href="https://guyabel.com/"><img class="avatar mr-3 avatar-circle" src="/author/guy-abel/avatar_hu5586689ca903b99c3d2e8ba7e4c0b0ce_470585_270x270_fill_q75_lanczos_center.jpg" alt="Guy Abel"></a>
    

    <div class="media-body">
      <h5 class="card-title"><a href="https://guyabel.com/">Guy Abel</a></h5>
      <h6 class="card-subtitle">Professor</h6>
      <p class="card-text">My research interests include migration, statistical programming and demographic methods.</p>
      <ul class="network-icon" aria-hidden="true">
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://scholar.google.co.uk/citations?user=MqztgqsAAAAJ" target="_blank" rel="noopener">
        <i class="fas fa-graduation-cap"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://orcid.org/0000-0002-4893-5687" target="_blank" rel="noopener">
        <i class="fab fa-orcid"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://github.com/guyabel" target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://bsky.app/profile/guyabel.bsky.social" target="_blank" rel="noopener">
        <i class="fab fa-bluesky"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://twitter.com/guyabelguyabel" target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="/#contact" >
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="/" >
        <i class="fas fa-"></i>
      </a>
    </li>
  
</ul>

    </div>
  </div>


  














  
  
  <div class="article-widget content-widget-hr">
    <h3>Related</h3>
    <ul>
      
      <li><a href="/post/animated-sankey/">Animated Sankey plots of global migrant populations</a></li>
      
      <li><a href="/post/animated-population-treemaps/">Animated population tree maps</a></li>
      
      <li><a href="/post/tidycat/">Expand broom::tidy() output for categorical parameter estimates</a></li>
      
      <li><a href="/post/chinese-migration-chord-diagram/">R code for chord diagrams of Chinese internal migration</a></li>
      
      <li><a href="/post/uefa-ec-chord-diagram/">The evolution of squad compositions at UEFA European Championships</a></li>
      
    </ul>
  </div>
  




          </div>
        </article>
      <script src="https://utteranc.es/client.js"
              repo="guyabel/personal-site"
              theme="preferred-color-scheme"
              issue-term="title"
              crossorigin="anonymous"
              async>
      </script>
    </main>
    </div>
  </div>
</div>
  </div>

  <div class="page-footer">
    
    
    <div class="container">
      <footer class="site-footer">

  


  
   





  
  
  
  

  
  
    
  
  
    
  

  

  
  <p class="powered-by copyright-license-text">
    This work is licensed under <a href="https://creativecommons.org/licenses/by-nc-nd/4.0" rel="noopener noreferrer" target="_blank">CC BY NC ND 4.0</a>
  </p>
  

  <p class="powered-by footer-license-icons">
    <a href="https://creativecommons.org/licenses/by-nc-nd/4.0" rel="noopener noreferrer" target="_blank" aria-label="Creative Commons">
      <i class="fab fa-creative-commons fa-2x" aria-hidden="true"></i>
      <i class="fab fa-creative-commons-by fa-2x" aria-hidden="true"></i>
      
        <i class="fab fa-creative-commons-nc fa-2x" aria-hidden="true"></i>
      
      
        <i class="fab fa-creative-commons-nd fa-2x" aria-hidden="true"></i>
      
    </a>
  </p>




  <p class="powered-by">
    © 2024 Guy Abel &middot; 
    Made with the <a href="https://github.com/rstudio/blogdown" target="_blank" rel="noopener">blogdown</a> package in <a href="https://cran.r-project.org/" target="_blank" rel="noopener"><i class="fab fa-r-project"></i></a> using the <a href="https://wowchemy.com/" target="_blank" rel="noopener">Academic theme</a> for <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a> and <a href="https://github.com/guyabel/personal-site" target="_blank" rel="noopener">Github <i class="fab fa-github"></i></a>

    
    <span class="float-right" aria-hidden="true">
      <a href="#" id="back_to_top">
        <span class="button_icon">
          <i class="fas fa-chevron-up fa-2x"></i>
        </span>
      </a>
    </span>
    
  </p>
  
  

</footer>

    </div>
    
  </div>

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

      

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/instant.page/5.1.0/instantpage.min.js" integrity="sha512-1+qUtKoh9XZW7j+6LhRMAyOrgSQKenQ4mluTR+cvxXjP1Z54RxZuzstR/H9kgPXQsVB8IW7DMDFUJpzLjvhGSQ==" crossorigin="anonymous"></script>

      
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      

      
      

      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/highlight.min.js" integrity="sha512-TDKKr+IvoqZnPzc3l35hdjpHD0m+b2EC2SrLEgKDRWpxf2rFCxemkgvJ5kfU48ip+Y+m2XVKyOCD85ybtlZDmw==" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/r.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/python.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/latex.min.js"></script>
        
      

    

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.js" integrity="sha512-SeiQaaDh73yrb56sTW/RgVdi/mMqNeM2oBwubFHagc5BkixSpP1fvqF47mKzPGWYSSy4RwbBunrJBQ4Co8fRWA==" crossorigin="anonymous"></script>
    

    
    

    
    
    
      
      <script id="search-hit-fuse-template" type="text/x-template">
        <div class="search-hit" id="summary-{{key}}">
          <div class="search-hit-content">
            <div class="search-hit-name">
              <a href="{{relpermalink}}">{{title}}</a>
              <div class="article-metadata search-hit-type">{{type}}</div>
              <p class="search-hit-description">{{snippet}}</p>
            </div>
          </div>
        </div>
      </script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
      
    

    
    

    
    
    
    

    
    <script src="/js/bootstrap.bundle.min.8b7df62fd2da18ce73e29c13cc0a6198.js"></script>

    
    
      
      
      
      
      
      
      
    

    
    
    
    
    
    
    
    
      
      
    
    
    <script src="/en/js/wowchemy.min.4bba0826db6409c865d2e7b99039d6d0.js"></script>

    
  <script async defer src="https://buttons.github.io/buttons.js"></script>


<html>
  <body>
    <script async src="https://badge.dimensions.ai/badge.js" charset="utf-8"></script>
    <script type='text/javascript' src='https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js'></script>
  </body>
</html>


</body>
</html>
